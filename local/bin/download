#!/bin/bash
# Download a file from the browser to the VM (triggers browser file picker)
# Usage: download [destination]

dest="${1:-.}"

# Clean staging area
rm -rf /data/* /data/.* 2>/dev/null

# Trigger browser file picker via OSC
printf '\e]7337;filepicker\a'

# Wait for a file to appear (temp files are hidden, so ls only shows the final file)
echo "Waiting for file selection..."
while true; do
    filename=$(ls /data/ 2>/dev/null | head -1)
    [ -n "$filename" ] && break
    sleep 0.2
done

if [ -d "$dest" ]; then
    cp "/data/$filename" "$dest/$filename"
    echo "Saved to $dest/$filename"
else
    cp "/data/$filename" "$dest"
    echo "Saved to $dest"
fi

# Clean up staging area
rm -f "/data/$filename"
